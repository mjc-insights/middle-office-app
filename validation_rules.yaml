# Validation rules configuration for PE Middle Office App
# Scope: U.S. equities trade validation and STP readiness checks
# Edit messages/owners without changing code behavior.

version: "2025-08-18"
rules:
  - code: presence_missing_field
    category: schema
    severity: critical
    owner: Middle Office + Trading
    message: "Missing required field"
    fields_required: [trade_date, settlement_date, side, quantity, security_id, price, counterparty_legal_name]
    action: "Do not process. Fix missing fields, then re-run validation."

  - code: quantity_nonpositive
    category: schema
    severity: critical
    owner: Middle Office + Trading
    message: "Quantity must be > 0"
    check: "quantity > 0"
    action: "Correct quantity to a positive value."

  - code: price_nonpositive
    category: schema
    severity: critical
    owner: Middle Office + Trading
    message: "Price must be > 0"
    check: "price > 0"
    action: "Correct price to a positive value."

  - code: invalid_side
    category: schema
    severity: critical
    owner: Middle Office + Trading
    message: "Side must be Buy or Sell"
    allowed_values: [Buy, Sell]
    action: "Correct the side value."

  - code: unknown_security
    category: business
    severity: high
    owner: Reference Data
    message: "Security not found or inactive"
    check: "security_id in active security master"
    action: "Onboard/activate security in the Security Master."

  - code: unknown_counterparty
    category: business
    severity: high
    owner: Middle Office (Ops)
    message: "Counterparty not found or inactive"
    check: "counterparty_legal_name in active SSI"
    action: "Add/activate counterparty in SSI or correct name on trade."

  - code: incomplete_ssi
    category: business
    severity: high
    owner: Middle Office (Ops)
    message: "Missing SSI depository/cash details for US Equities"
    check: "for market == 'US Equities', require depository_account and cash_account"
    action: "Obtain and update SSI depository and cash account details."

  - code: bad_settlement_cycle
    category: settlement
    severity: high
    owner: Middle Office (Ops)
    message: "Settlement date does not match configured cycle"
    check: "settlement_date == trade_date + N business days (N from security_master.settlement_cycle)"
    action: "Fix trade settlement date or correct security's settlement_cycle."

  - code: weekend_or_holiday_settlement
    category: settlement
    severity: high
    owner: Middle Office (Ops)
    message: "Settlement date falls on weekend/holiday"
    check: "settlement_date not in weekend and not in holiday_calendar"
    action: "Move to next valid business day."

  - code: ctm_affirmation_sla
    category: post_trade
    severity: high
    owner: Middle Office (Ops)
    message: "Trade not affirmed; target is 90% affirmed by 9:00 p.m. ET on trade date"
    check: "ctm_status not in {'Affirmed','AutoAffirmed'}; escalate as minutes_to_cutoff(21:00 ET) decreases"
    action: "Complete allocations by ~7:00 p.m. ET and affirm in CTM by 9:00 p.m. ET"
    fields_required: []
    ui:
      badge_policy: "minutes_to_cutoff -> severity"
      countdown_target_time_et: "21:00"

  - code: ssi_not_from_alert_or_incomplete
    category: settlement
    severity: high
    owner: Middle Office (Ops)
    message: "SSI not sourced from ALERT or required depository/cash fields missing"
    check: "ssi.source != 'ALERT' OR missing_any(required_ssi_fields_us_equities)"
    action: "Pull SSIs from ALERT; complete depository_id, depository_acct, cash_bank_bic, cash_acct"
    fields_required:
      - "depository_id"
      - "depository_acct"
      - "cash_bank_bic"
      - "cash_acct"

  - code: price_outside_luld_band
    category: trading_controls
    severity: critical
    owner: Trading + Compliance
    message: "Execution price outside LULD band at the time of trade"
    check: "asset_class == 'Equity' AND NOT (luld_lower <= exec_price <= luld_upper)"
    action: "Review venue and price protection; correct or cancel"
    fields_required: []
    parameters:
      data_source: "sip_or_vendor_luld_feed"

  - code: short_sale_marking_invalid
    category: compliance
    severity: high
    owner: Compliance + Trading
    message: "Short-sale marking or locate status is inconsistent"
    check: "(side in {'Sell Short','Sell Short Exempt'} AND locate_status not in {'Located','ETB'}) OR (side == 'Sell' AND short_mark in {'Short','Short Exempt'})"
    action: "Correct Tag 54 side/mark and ensure locate/ETB status is captured"
    fields_required:
      - "side"
      - "short_mark"
      - "locate_status"
    allowed_values:
      side: ["Buy","Sell","Sell Short","Sell Short Exempt"]

  - code: duplicate_trade_detected
    category: schema
    severity: critical
    owner: Middle Office + Tech
    message: "Duplicate trade detected by unique key; potential double-book"
    check: "exists_in_store(unique_key in {'trade_report_id','exec_id'} plus trade_date/symbol/qty/price)"
    action: "Reject or queue for review per duplicate_key_policy; use idempotent upsert"
    fields_required:
      - "trade_report_id"
    parameters:
      unique_key_hint: ["trade_report_id","exec_id","trade_date","symbol","quantity","price"]

# Optional: parameters the app can read (e.g., confirm matching tolerances)
parameters:
  price_tolerance_bps: 5        # 5 bps tolerance for price compare (if used later)
  price_tolerance_abs: 0.02     # $0.02 absolute tolerance (if used later)
  quantity_tolerance: 0         # quantities must match exactly for equities
  ctm_cutoff_time_et: "21:00"
  ctm_warn_minutes: 120
  ctm_critical_minutes: 30
  luld_data_source: "sip_or_vendor_luld_feed"
  duplicate_key_policy: "idempotent_upsert"
  allowed_short_side_values: ["Sell Short","Sell Short Exempt"]
  required_ssi_fields_us_equities: ["depository_id","depository_acct","cash_bank_bic","cash_acct"]
